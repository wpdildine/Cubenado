function particleRange(){this.partVal=document.getElementById("nbParticles"),this.partVal.addEventListener("change",function(e){document.getElementById("labelParticles").innerHTML=parseInt(partVal.value)},!1)}function randomizeRotationRange(){rotationSlider.addEventListener("change",function(e){rotationSeedValue=parseInt(document.getElementById("randomRotation").value),document.getElementById("seedRotation").innerHTML=rotationSeedValue,Math.seed=rotationSeedValue})}function gravityRange(){gravitySlider.addEventListener("change",function(e){gravityValue=parseInt(document.getElementById("gravitySlide").value),document.getElementById("gravityVal").innerHTML=gravityValue})}function speedRange(){speedSlider.addEventListener("change",function(e){speedValue=parseInt(document.getElementById("speedSlide").value),document.getElementById("speedVal").innerHTML=speedValue})}function scaleRange(){scaleSlider.addEventListener("change",function(e){scaleValue=parseInt(document.getElementById("scaleSlide").value),document.getElementById("scaleVal").innerHTML=scaleValue})}function vortexRange(){vortexSlider.addEventListener("change",function(e){vortexValue=parseInt(document.getElementById("vortexSlide").value),document.getElementById("vortexVal").innerHTML=vortexValue})}function changeMaterial(){scene.meshes[0].material==scene.getMaterialByName("shader")?scene.meshes[0].material=scene.getMaterialByName("mat1"):scene.meshes[0].material=scene.getMaterialByName("shader")}var particleCount=parseInt(document.getElementById("nbParticles").value),particleRangeSlider=document.getElementById("nbParticles"),rotationSeedValue=parseInt(document.getElementById("seedRotation").value),rotationSlider=document.getElementById("randomRotation"),gravityValue=0,gravitySlider=document.getElementById("gravitySlide"),speedValue=2,speedSlider=document.getElementById("speedSlide"),scaleValue=2,scaleSlider=document.getElementById("scaleSlide"),vortexValue=2,vortexSlider=document.getElementById("vortexSlide");particleRange(),particleRangeSlider.addEventListener("change",function(e){particleCount=parseInt(document.getElementById("nbParticles").value)}),randomizeRotationRange(),gravityRange(),speedRange(),scaleRange(),vortexRange(),Math.seed=6,Math.seededRandom=function(e,n){e=e||1,n=n||0,Math.seed=(9301*Math.seed+49297)%233280;var t=Math.seed/233280;return n+t*(e-n)};var fps={startTime:0,frameNumber:0,getFPS:function(){this.frameNumber++;var e=(new Date).getTime(),n=(e-this.startTime)/1e3,t=Math.floor(this.frameNumber/n);return n>1&&(this.startTime=(new Date).getTime(),this.frameNumber=0),t}},canvas=document.querySelector("#render"),engine=new BABYLON.Engine(canvas,!0),createScene=function(){var e=new BABYLON.Scene(engine);e.clearColor=new BABYLON.Color3(0,0,0);var n=new BABYLON.ArcRotateCamera("camera1",0,0,0,new BABYLON.Vector3(0,0,-0),e);n.setPosition(new BABYLON.Vector3(0,50,-300)),n.attachControl(canvas,!0);var t=new BABYLON.HemisphericLight("light1",new BABYLON.Vector3(1,1,0),e);t.intensity=.9;var r=new BABYLON.PointLight("light2",new BABYLON.Vector3(100,1e3,1),e);r.diffuse=new BABYLON.Color3(1,0,0),r.specular=new BABYLON.Color3(1,1,0),BABYLON.Effect.ShadersStore.customVertexShader="precision highp float;\r\n// Attributes\r\nattribute vec3 position;\r\nattribute vec3 normal;\r\nattribute vec2 uv;\r\n// Uniforms\r\nuniform mat4 world;\r\nuniform mat4 worldViewProjection;\r\n// Varying\r\nvarying vec3 vPositionW;\r\nvarying vec3 vNormalW;\r\nvarying vec2 vUV;\r\nvoid main(void) {\r\n    vec4 outPosition = worldViewProjection * vec4(position, 1.0);\r\n    gl_Position = outPosition;\r\n    \r\n    vPositionW = vec3(world * vec4(position, 1.0));\r\n    vNormalW = normalize(vec3(world * vec4(normal, 0.0)));\r\n    \r\n    vUV = uv;\r\n}\r\n",BABYLON.Effect.ShadersStore.customFragmentShader="precision highp float;\r\n// Lights\r\nvarying vec3 vPositionW;\r\nvarying vec3 vNormalW;\r\nvarying vec2 vUV;\r\n// Refs\r\nuniform sampler2D textureSampler;\r\nuniform vec3 lightPosition;\r\nuniform float time;\r\nvoid main(void) {\r\n    float ToonThresholds[4];\r\n    ToonThresholds[0] = 0.95;\r\n    ToonThresholds[1] = 0.5;\r\n    ToonThresholds[2] = 0.2;\r\n    ToonThresholds[3] = 0.03;\r\n    \r\n    float ToonBrightnessLevels[5];\r\n    ToonBrightnessLevels[0] = 1.0;\r\n    ToonBrightnessLevels[1] = 0.8;\r\n    ToonBrightnessLevels[2] = 0.6;\r\n    ToonBrightnessLevels[3] = 0.35;\r\n    ToonBrightnessLevels[4] = 0.2;\r\n    \r\n    vec3 vLightPosition = lightPosition;\r\n    \r\n    // Light\r\n    vec3 lightVectorW = normalize(vLightPosition - vPositionW);\r\n    \r\n    // diffuse\r\n    float ndl = max(0., dot(vNormalW, lightVectorW));\r\n    \r\n    vec3 color = vec3(1.0*sin(time) , 0.3, 0.3);\r\n    \r\n    if (ndl > ToonThresholds[0])\r\n    {\r\n        color *= ToonBrightnessLevels[0];\r\n    }\r\n    else if (ndl > ToonThresholds[1])\r\n    {\r\n        color *= ToonBrightnessLevels[1];\r\n    }\r\n    else if (ndl > ToonThresholds[2])\r\n    {\r\n        color *= ToonBrightnessLevels[2];\r\n    }\r\n    else if (ndl > ToonThresholds[3])\r\n    {\r\n        color *= ToonBrightnessLevels[3];\r\n    }\r\n    else\r\n    {\r\n        color *= ToonBrightnessLevels[4];\r\n    }\r\n    \r\n    gl_FragColor = vec4(color.r, color.g, color.b, 1.);\r\n}\r\n";var o=new BABYLON.ShaderMaterial("shader",e,{vertex:"custom",fragment:"custom"},{attributes:["position","normal","uv"],uniforms:["world","worldView","worldViewProjection","view","projection"]});o.setColor3("rgb",.3,.3,.3),o.setFloat("time",0),o.setVector3("cameraPosition",BABYLON.Vector3.Zero()),o.backFaceCulling=!1;var a=new BABYLON.StandardMaterial("mat1",e);a.backFaceCulling=!0;var i=new BABYLON.Texture("assets/bw.jpg",e);a.diffuseTexture=i;var l=BABYLON.MeshBuilder.CreateBox("box",{size:2,segments:1},e),s=new BABYLON.SolidParticleSystem("SPS",e);s.addShape(l,1e4);var c=s.buildMesh();c.material=a,c.position.y=-100,l.dispose();var d=1.5;return s.initParticles=function(){for(var e=0;e<this.nbParticles;e++)this.recycleParticle(this.particles[e])},s.recycleParticle=function(e){if(e.idx>particleCount?e.alive=!1:e.alive=!0,!e.alive){if(0==e.scale.y)return;return e.scale.x=0,e.scale.y=0,e.scale.z=0,e.position.x=6*Math.random(),e.position.y=6*Math.random(),void(e.position.z=6*Math.random())}e.position.x=6*Math.random(),e.position.y=6*Math.random(),e.position.z=6*Math.random(),e.velocity.x=(Math.random()-.5)*d,e.velocity.y=Math.random()*d,e.velocity.z=(Math.random()-.5)*d;var n=scaleValue-3*Math.random();e.scale.x=n,e.scale.y=n,e.scale.z=n,e.rotation.x=3.5*Math.seededRandom(),e.rotation.y=3.5*Math.seededRandom(),e.rotation.z=3.5*Math.seededRandom(),e.color.r=.6*Math.random()+.5,e.color.g=.6*Math.random()+.5,e.color.b=.6*Math.random()+.5},s.updateParticle=function(e){(e.position.y>200||e.position.y<0||Math.pow(e.position.x-0,2)+Math.pow(e.position.z-0,2)>Math.pow(140,2))&&this.recycleParticle(e),e.velocity.y+=.01*gravityValue,e.position.addInPlace(e.velocity),e.position.y+=speedValue/4;var n=e.idx%2==0?1:-1;e.rotation.z+=.1*n,e.rotation.x+=.05*n,e.rotation.y+=.008*n},s.initParticles(),s.computeParticleColor=!0,s.computeParticleTexture=!0,e.registerBeforeRender(function(){s.setParticles(),s.mesh.rotation.y+=.025*vortexValue,o.setVector3("lightPosition",r.position)}),e},scene=createScene(),time=0,f=document.querySelector("#fps");engine.runRenderLoop(function(){f.innerHTML=fps.getFPS();var e=scene.getMaterialByName("shader");e.setFloat("time",time),time+=.02,e.setVector3("cameraPosition",scene.activeCamera.position),scene.render()}),window.addEventListener("resize",function(){engine.resize()});